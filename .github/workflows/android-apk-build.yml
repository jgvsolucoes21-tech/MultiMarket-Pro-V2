# Este workflow usa la estructura estándar de Node.js de GitHub, 
# a la que se le añadieron los pasos de Capacitor y Android SDK para 
# generar un archivo .apk de debug.

name: Build Android APK (Capacitor)

on:
  push:
    branches:
      - main
      - master 
  # Permite ejecutar el workflow manualmente
  workflow_dispatch: 

permissions:
  contents: read

jobs:
  build_apk:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]
        # quitamos otros sistemas operativos, ya que solo necesitamos Android/Linux
    
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      # 1. Instalación de todas las dependencias (incluyendo Capacitor y React Scripts)
      - name: Install All Dependencies
        run: npm install

      # 2. Compilación de la Aplicación Web (Genera la carpeta 'build/')
      - name: Run Web Build (npm run build)
        run: npm run build

      # --- Pasos de Capacitor/Android ---
      
      # 3. Agrega la plataforma nativa de Android (puede fallar si ya existe)
      - name: Add Android Platform
        run: npx cap add android || true 
        
      # 4. Sincroniza el código web compilado (build/) con el proyecto Android
      - name: Sync Web Assets to Android Project
        run: npx cap sync android

      # 5. Configura el entorno Android (SDK) necesario para Gradle
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        
      # 6. Construcción del APK (dentro de la carpeta 'android')
      - name: Build Android Debug APK
        run: cd android && ./gradlew assembleDebug

      # 7. Archiva y sube el APK como un Artefacto descargable
      - name: Upload Debug APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MultiMarketPro-Debug-APK
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 5
